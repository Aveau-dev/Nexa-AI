<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta name="google-site-verification" content="1xRfZx8fEbwT18xMYj4l1UFl5jRckIrbs2uk4STqF6Y" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaAI â€“ Modern AI Assistant</title>

    <meta name="description"
        content="NexaAI is a modern, free, multi-model AI assistant platform. Chat with GPT-4, Claude, Gemini, DeepSeek, and more.">
    <meta name="keywords"
        content="AI, NexaAI, chatbot, GPT-4, Claude, Gemini, DeepSeek, OpenRouter, AI assistant, LLM, FOSS, chat history, free, ai tools">
    <link rel="canonical" href="https://nexa-ai.onrender.com/">
    <meta name="robots" content="index, follow">

    <!-- Green shield favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2319c37d' d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>">

    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">

    <!-- Open Graph / Twitter -->
    <meta property="og:title" content="NexaAI â€“ AI Chat Assistant" />
    <meta property="og:description"
        content="A smart, free AI chat dashboard supporting GPT-4, Claude, Gemini, and more." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://nexa-ai.onrender.com/static/og-image.png" />

    <!-- Markdown + syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Polyfills -->
    <script>
        if (!window.Promise) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>');
        }
        if (!window.fetch) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.js"><\/script>');
        }
    </script>

    {% if current_user.is_authenticated %}
    <script>
        // Already logged in â†’ go straight to dashboard
        window.location.href = "{{ url_for('dashboard') }}";
    </script>
    {% endif %}
</head>

<body class="ds-body">
    <!-- Nav -->
    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo-container">
                <svg class="logo-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" />
                </svg>
                <span class="logo-text">NexaAI</span>
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-button secondary" onclick="location.href='{{ url_for('login') }}'">
                <span>L</span><span class="nav-full-text">og in</span>
            </button>
            <button class="nav-button primary" onclick="location.href='{{ url_for('signup') }}'">
                <span>S</span><span class="nav-full-text">ign up</span>
            </button>
            <button class="nav-button icon-only" type="button" onclick="openTermsModal()" title="Help">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 8a2 2 0 0 1 2 2c0 1-1 1.5-1.5 1.8-.4.3-.5.5-.5 1.2" />
                    <circle cx="12" cy="16" r="0.8" fill="currentColor" stroke="none" />
                </svg>
            </button>
        </div>
    </nav>

    <!-- Main -->
    <div class="landing-shell">
        <main class="landing-main">
            <div class="main-container">
                <div class="center-content">
                    <div class="welcome-section" id="welcome-section">
                        <h1 class="main-heading">What can I help with?</h1>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
                            ğŸ’¡ Try asking: "Explain quantum computing" or "Write a Python function"
                        </p>
                        <p style="color: var(--text-tertiary); margin-top: 0.25rem; font-size: 0.8rem;">
                            ğŸ§  Demo has temporary memory - I remember our conversation until you refresh
                        </p>
                    </div>

                    <div id="messages-container"></div>
                    <div style="height: 120px;"></div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-wrapper fixed-input">
                <div class="input-box">
                    <div class="input-inner">
                        <textarea id="chat-input" placeholder="Ask anything..." rows="1"></textarea>
                        <button class="send-button" id="send-btn" title="Send message">
                            <!-- send icon -->
                            <span id="send-icon">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                                </svg>
                            </span>
                            <!-- stop icon -->
                            <span id="stop-icon" style="display:none;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect>
                                </svg>
                            </span>
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="demo-notice">
                            ğŸ Demo Mode â€“ Unlimited Â· Temporary memory Â·
                            <a href="javascript:void(0)" onclick="openTermsModal()"
                                style="text-decoration:underline;cursor:pointer;">Terms</a> Â·
                            <a href="{{ url_for('signup') }}" style="font-weight: 600;">Sign up for permanent history</a>
                        </span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="modal-overlay" style="display:none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Terms & Policies</h2>
                <button class="modal-close" onclick="closeTermsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>ğŸ”’ Privacy & Data Use</h3>
                <p>Demo mode has <strong>temporary memory</strong> - your conversation is remembered until you refresh 
                   the page. Conversations are <strong>not saved</strong> to our servers. Sign up for permanent chat history.</p>

                <h3>âš ï¸ AI Limitations</h3>
                <ul>
                    <li>AI responses may contain inaccurate or outdated information</li>
                    <li>Do not rely on AI for medical, legal, or financial advice</li>
                    <li>Always verify important information from authoritative sources</li>
                    <li>AI may occasionally produce biased or inappropriate content</li>
                </ul>

                <h3>âœ… Acceptable Use</h3>
                <ul>
                    <li>Be respectful and constructive in your queries</li>
                    <li>Do not attempt to jailbreak or manipulate the AI</li>
                    <li>Do not use for illegal activities or harmful purposes</li>
                    <li>Content moderation policies apply</li>
                </ul>

                <h3>ğŸ Demo vs Full Access</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                    <tr style="border-bottom: 1px solid var(--color-border);">
                        <td style="padding: 0.5rem;"><strong>Demo</strong></td>
                        <td style="padding: 0.5rem;">Unlimited, temporary memory, DeepSeek R1</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--color-border);">
                        <td style="padding: 0.5rem;"><strong>Free Account</strong></td>
                        <td style="padding: 0.5rem;">4 AI models, permanent history, image gen</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.5rem;"><strong>Pro (Free trial)</strong></td>
                        <td style="padding: 0.5rem;">All 9 models, DeepThink, Web, unlimited</td>
                    </tr>
                </table>

                <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border); font-size: 0.9rem;">
                    By using NexaAI, you agree to these terms. We respect your privacy and never sell your data.
                </p>
            </div>
        </div>
    </div>

    <!-- Demo Chat Script with Temporary Memory - UNLIMITED -->
    <script>
        /**
         * NexaAI Demo Page - With Temporary Memory - UNLIMITED
         * Features: Context-aware responses, Stop functionality, No rate limits
         * Author: Aarav
         * Date: 2026-01-07
         * Version: 6.0 - Unlimited Edition
         */

        'use strict';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE MANAGEMENT WITH TEMPORARY MEMORY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let isResponding = false;
        let abortController = null;

        // ğŸ§  TEMPORARY MEMORY - Stores conversation history (cleared on refresh)
        let conversationHistory = [];
        const MAX_HISTORY_LENGTH = 10; // Keep last 10 messages for context

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function autoLoginDemo() {
            try {
                const res = await fetch("/demo-login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });
                await res.json().catch(() => ({}));
                console.log('âœ… Demo session initialized - UNLIMITED');
            } catch (e) {
                console.warn("Auto demo login failed", e);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            autoLoginDemo();

            // Setup textarea auto-resize
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                });

                // Setup Enter key handler
                chatInput.addEventListener('keydown', handleKeyDown);
            }

            // Setup send button
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
                sendBtn.addEventListener('click', handleSendClick);
            }

            console.log('ğŸš€ NexaAI Demo loaded - UNLIMITED with temporary memory');
            console.log('ğŸ§  Memory will persist until page refresh');
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT HANDLERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendClick();
            }
        }

        function handleSendClick() {
            if (isResponding) {
                stopAIResponse();
            } else {
                sendMessage();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INPUT STATE MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function setInputState(locked) {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');

            isResponding = locked;

            if (input) {
                input.readOnly = locked;
                input.classList.toggle('input-disabled', locked);
                if (!locked) input.focus();
            }

            if (btn) {
                btn.disabled = false;
                btn.title = locked ? 'Stop response' : 'Send message';
            }

            if (sendIcon && stopIcon) {
                sendIcon.style.display = locked ? 'none' : 'inline-flex';
                stopIcon.style.display = locked ? 'inline-flex' : 'none';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STOP AI RESPONSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function stopAIResponse() {
            if (!isResponding) return;

            console.log('ğŸ›‘ User stopped AI response');

            if (abortController) {
                abortController.abort();
            }

            removeTypingIndicator();
            addMessage('â¸ï¸ Response stopped by user', 'system');

            setInputState(false);
            isResponding = false;
            abortController = null;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TEMPORARY MEMORY MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function addToMemory(role, content) {
            conversationHistory.push({
                role: role,
                content: content,
                timestamp: Date.now()
            });

            // Keep only last MAX_HISTORY_LENGTH messages
            if (conversationHistory.length > MAX_HISTORY_LENGTH) {
                conversationHistory = conversationHistory.slice(-MAX_HISTORY_LENGTH);
            }

            console.log(`ğŸ§  Memory updated: ${conversationHistory.length} messages stored`);
        }

        function getContextForAPI() {
            // Return last 6 messages for API context (3 exchanges)
            const recentHistory = conversationHistory.slice(-6);
            return recentHistory.map(msg => ({
                role: msg.role,
                content: msg.content
            }));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEND MESSAGE WITH MEMORY - NO LIMITS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input ? input.value.trim() : '';

            if (!message) return;

            // Hide welcome on first message
            const welcome = document.getElementById('welcome-section');
            if (welcome) {
                welcome.style.display = 'none';
            }

            // Add user message to UI
            addMessage(message, 'user');

            // Add to memory
            addToMemory('user', message);

            // Clear input
            if (input) {
                input.value = '';
                input.style.height = 'auto';
            }

            // Show typing
            showTypingIndicator();
            setInputState(true);

            // Create abort controller
            abortController = new AbortController();

            try {
                // Get conversation context
                const context = getContextForAPI();
                console.log(`ğŸ“¤ Sending with ${context.length} messages of context`);

                const res = await fetch('/demo-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        context: context
                    }),
                    signal: abortController.signal
                });

                // Handle SSE streaming
                if (res.ok && res.headers.get('content-type')?.includes('text/event-stream')) {
                    await handleSSEStream(res);
                } else {
                    // Fallback to JSON
                    const data = await res.json();
                    removeTypingIndicator();
                    setInputState(false);
                    abortController = null;

                    if (data.response) {
                        addMessage(data.response, 'assistant', data.model);
                        addToMemory('assistant', data.response);
                    } else if (data.error) {
                        handleError(data.error);
                    }
                }

            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Request aborted by user');
                    return;
                }

                removeTypingIndicator();
                setInputState(false);
                abortController = null;

                console.error('Fetch error:', err);
                addMessage('âŒ Network error. Please check your connection and try again.', 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SSE STREAMING HANDLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function handleSSEStream(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';
            let modelName = 'DeepSeek R1';
            let messageElement = null;

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.trim() || line.startsWith(':')) continue;

                        if (line.startsWith('event:')) {
                            const event = line.substring(6).trim();

                            if (event === 'meta') {
                                // Next line should be data
                                continue;
                            } else if (event === 'token') {
                                // Next line has token data
                                continue;
                            } else if (event === 'done') {
                                // Stream complete
                                removeTypingIndicator();
                                if (fullResponse) {
                                    addMessage(fullResponse, 'assistant', modelName);
                                    addToMemory('assistant', fullResponse);
                                }
                                setInputState(false);
                                abortController = null;
                                return;
                            } else if (event === 'error') {
                                // Error occurred
                                continue;
                            }
                        } else if (line.startsWith('data:')) {
                            const jsonStr = line.substring(5).trim();
                            if (!jsonStr || jsonStr === '{}') continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                if (data.messages_analyzed !== undefined) {
                                    modelName = data.model || 'DeepSeek R1';
                                    removeTypingIndicator();
                                    messageElement = createStreamingMessage(modelName);
                                } else if (data.delta) {
                                    fullResponse += data.delta;
                                    if (messageElement) {
                                        updateStreamingMessage(messageElement, fullResponse);
                                    }
                                } else if (data.error) {
                                    removeTypingIndicator();
                                    handleError(data.error);
                                    setInputState(false);
                                    abortController = null;
                                    return;
                                }
                            } catch (e) {
                                console.warn('JSON parse error:', e);
                            }
                        }
                    }
                }

                // Stream ended
                removeTypingIndicator();
                if (fullResponse && !messageElement) {
                    addMessage(fullResponse, 'assistant', modelName);
                    addToMemory('assistant', fullResponse);
                }
                setInputState(false);
                abortController = null;

            } catch (error) {
                console.error('Stream error:', error);
                removeTypingIndicator();
                setInputState(false);
                abortController = null;
            }
        }

        function createStreamingMessage(modelName) {
            const container = document.getElementById('messages-container');
            if (!container) return null;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-row assistant-row streaming-message';
            messageDiv.innerHTML = `
                <div class="message assistant-message">
                    <div class="avatar">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"></path>
                        </svg>
                    </div>
                    <div class="message-content">
                        <div class="model-badge">${escapeHtml(modelName)}</div>
                        <div class="markdown-content"></div>
                    </div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            return messageDiv.querySelector('.markdown-content');
        }

        function updateStreamingMessage(element, text) {
            if (!element) return;
            element.innerHTML = formatDemoMessage(text);

            if (typeof hljs !== 'undefined') {
                element.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            }

            addDemoCopyButtons(element);

            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ERROR HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function handleError(errorMsg) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-row error-row';
            messageDiv.innerHTML = `
                <div class="message error-message">
                    <div class="message-content">âš ï¸ ${escapeHtml(errorMsg)}</div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MESSAGE FORMATTING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : String(text);
            return div.innerHTML;
        }

        function formatDemoMessage(text) {
            if (typeof marked === 'undefined') {
                return escapeHtml(text).replace(/\n/g, '<br>');
            }

            marked.setOptions({
                highlight(code, lang) {
                    if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return (typeof hljs !== 'undefined') ? hljs.highlightAuto(code).value : code;
                },
                breaks: true,
                gfm: true
            });

            return marked.parse(text);
        }

        function addDemoCopyButtons(container) {
            container.querySelectorAll('pre code').forEach((codeBlock) => {
                const pre = codeBlock.parentElement;

                if (pre.querySelector('.copy-code-btn')) return;

                const btn = document.createElement('button');
                btn.className = 'copy-code-btn';
                btn.textContent = 'Copy';

                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                        btn.textContent = 'Copied!';
                        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
                    });
                });

                pre.style.position = 'relative';
                btn.style.position = 'absolute';
                btn.style.top = '8px';
                btn.style.right = '8px';
                pre.appendChild(btn);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADD MESSAGE TO UI
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function addMessage(text, role, modelName = null) {
            const container = document.getElementById('messages-container');
            if (!container) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-row ${role}-row`;

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message user-message">
                        <div class="message-content">${escapeHtml(text)}</div>
                    </div>
                `;

            } else if (role === 'assistant') {
                messageDiv.innerHTML = `
                    <div class="message assistant-message">
                        <div class="avatar">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"></path>
                            </svg>
                        </div>
                        <div class="message-content">
                            ${modelName ? `<div class="model-badge">${escapeHtml(modelName)}</div>` : ''}
                            <div class="markdown-content"></div>
                        </div>
                    </div>
                `;

                const contentDiv = messageDiv.querySelector('.markdown-content');
                contentDiv.innerHTML = formatDemoMessage(text);

                if (typeof hljs !== 'undefined') {
                    contentDiv.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
                }

                addDemoCopyButtons(contentDiv);
                addMessageActions(contentDiv, text);

            } else if (role === 'system') {
                messageDiv.innerHTML = `
                    <div class="message system-message">
                        <div class="message-content">${escapeHtml(text)}</div>
                    </div>
                `;

            } else {
                messageDiv.innerHTML = `
                    <div class="message error-message">
                        <div class="message-content">âš ï¸ ${escapeHtml(text)}</div>
                    </div>
                `;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MESSAGE ACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function addMessageActions(contentDiv, text) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            actions.innerHTML = `
                <button class="msg-btn" data-action="listen" title="Listen">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
                <button class="msg-btn" data-action="like" title="Like">ğŸ‘</button>
                <button class="msg-btn" data-action="dislike" title="Dislike">ğŸ‘</button>
                <button class="msg-btn" data-action="copy" title="Copy">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            `;

            actions.addEventListener('click', (e) => {
                const btn = e.target.closest('.msg-btn');
                if (btn) handleMessageAction(btn.dataset.action, text, actions);
            });

            contentDiv.appendChild(actions);
        }

        function handleMessageAction(action, text, actionsEl) {
            if (action === 'listen') {
                try {
                    if (speechSynthesis.speaking) {
                        speechSynthesis.cancel();
                    }
                    const utter = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utter);
                    console.log('ğŸ”Š Text-to-speech started');
                } catch (e) {
                    console.warn('Text-to-speech not supported', e);
                }

            } else if (action === 'like') {
                actionsEl.classList.add('liked');
                actionsEl.classList.remove('disliked');

            } else if (action === 'dislike') {
                actionsEl.classList.add('disliked');
                actionsEl.classList.remove('liked');

            } else if (action === 'copy') {
                navigator.clipboard.writeText(text).then(() => {
                    const btn = actionsEl.querySelector('[data-action="copy"]');
                    if (btn) {
                        const originalHTML = btn.innerHTML;
                        btn.textContent = 'âœ“';
                        setTimeout(() => { btn.innerHTML = originalHTML; }, 1500);
                    }
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TYPING INDICATOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function showTypingIndicator() {
            const container = document.getElementById('messages-container');
            if (!container || document.getElementById('typing-indicator')) return;

            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-row assistant-row typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message assistant-message">
                    <div class="avatar">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"></path>
                        </svg>
                    </div>
                    <div class="typing-dots"><span></span><span></span><span></span></div>
                </div>
            `;

            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODAL HANDLERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function openTermsModal() {
            const modal = document.getElementById('terms-modal');
            if (!modal) return;
            modal.style.display = 'flex';
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
        }

        function closeTermsModal() {
            const modal = document.getElementById('terms-modal');
            if (!modal) return;
            modal.style.display = 'none';
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
        }

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('terms-modal');
            if (modal && e.target === modal) {
                closeTermsModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (isResponding) {
                    stopAIResponse();
                }
                closeTermsModal();
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEBUG INFO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        window.addEventListener('beforeunload', () => {
            console.log('ğŸ§¹ Page refreshing - memory will be cleared');
            console.log(`ğŸ“Š Session stats: ${conversationHistory.length} messages in memory`);
        });

    </script>
</body>

</html>
