<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaAI - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2319c37d' d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="nav-button icon-only" id="sidebar-toggle">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
                </svg>
            </button>
            <button class="nav-button" id="new-chat-btn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                <span>New chat</span>
            </button>
            <div class="logo-container">
                <svg class="logo-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" />
                </svg>
                <button class="model-selector-btn" id="model-selector-btn">
                    <span id="selected-model-name">GPT-3.5 Turbo</span>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="nav-right">
            {% if not user.is_premium %}
            <button class="nav-button upgrade-btn" onclick="location.href='/checkout'">
                <span>‚≠ê Upgrade to Premium</span>
            </button>
            {% else %}
            <div class="premium-badge-nav">‚≠ê Premium</div>
            {% endif %}
            <button class="nav-button icon-only" id="user-menu-btn">
                <div class="user-avatar">{{ user.name[0].upper() }}</div>
            </button>
        </div>
    </nav>

    <!-- Model Selector Dropdown -->
    <div id="model-selector" class="model-selector-dropdown" style="display: none;">
        <div class="model-selector-header">
            <h3>Select AI Model</h3>
            <button class="close-selector" id="close-selector-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
        </div>

        <div class="model-selector-content">
            <!-- Free Models -->
            <div class="model-group">
                <div class="model-group-header">
                    <span class="group-badge free">Free</span>
                    <span class="group-title">Available for Everyone</span>
                </div>

                {% for model_key, model_data in models.items() if model_key in ['gpt-3.5-turbo', 'claude-3-haiku', 'gemini-flash', 'deepseek-chat'] %}
                <div class="model-card {% if loop.first %}active{% endif %}" data-model="{{ model_key }}" data-name="{{ model_data.name }}">
                    <div class="model-card-header">
                        <div class="model-icon">
                            {% if 'gpt' in model_key %}
                            <span class="icon-text">ü§ñ</span>
                            {% elif 'claude' in model_key %}
                            <span class="icon-text">üé≠</span>
                            {% elif 'gemini' in model_key %}
                            <span class="icon-text">‚ú®</span>
                            {% elif 'deepseek' in model_key %}
                            <span class="icon-text">üîç</span>
                            {% else %}
                            <span class="icon-text">üí¨</span>
                            {% endif %}
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">{{ model_data.name }}</h4>
                            <div class="model-features">
                                {% if model_data.vision %}
                                <span class="feature-badge vision">üì∑ Vision</span>
                                {% endif %}
                                {% if model_data.limit %}
                                <span class="feature-badge limit">{{ model_data.limit }}/day</span>
                                {% endif %}
                                <span class="feature-badge speed">‚ö° Fast</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        {% if 'gpt-3.5' in model_key %}
                        Fast and efficient for everyday tasks
                        {% elif 'claude-3-haiku' in model_key %}
                        Fast Claude model, great for quick responses
                        {% elif 'gemini-flash' in model_key %}
                        Google's fast and efficient model
                        {% elif 'deepseek' in model_key %}
                        Advanced reasoning with daily limit
                        {% else %}
                        Versatile AI model
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Premium Models -->
            {% if user.is_premium %}
            <div class="model-group">
                <div class="model-group-header">
                    <span class="group-badge premium">‚≠ê Premium</span>
                    <span class="group-title">Unlimited Access</span>
                </div>

                {% for model_key, model_data in models.items() if model_key in ['gpt-4o', 'gpt-4o-mini', 'claude-3.5-sonnet', 'claude-3-opus', 'gemini-pro', 'deepseek-r1'] %}
                <div class="model-card premium" data-model="{{ model_key }}" data-name="{{ model_data.name }}">
                    <div class="model-card-header">
                        <div class="model-icon premium">
                            {% if 'gpt-4' in model_key %}
                            <span class="icon-text">üß†</span>
                            {% elif 'claude' in model_key %}
                            <span class="icon-text">üé≠</span>
                            {% elif 'gemini' in model_key %}
                            <span class="icon-text">üíé</span>
                            {% elif 'deepseek-r1' in model_key %}
                            <span class="icon-text">üöÄ</span>
                            {% else %}
                            <span class="icon-text">‚ö°</span>
                            {% endif %}
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">{{ model_data.name }}</h4>
                            <div class="model-features">
                                {% if model_data.vision %}
                                <span class="feature-badge vision">üì∑ Vision</span>
                                {% endif %}
                                <span class="feature-badge unlimited">‚àû Unlimited</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        {% if 'gpt-4o-mini' in model_key %}
                        Fast and cost-effective GPT-4 variant
                        {% elif 'gpt-4o' in model_key %}
                        Most advanced GPT with vision & reasoning
                        {% elif 'claude-3.5' in model_key %}
                        Best for coding, writing & analysis
                        {% elif 'claude-3-opus' in model_key %}
                        Most capable Claude model
                        {% elif 'gemini-pro' in model_key %}
                        Google's most capable AI
                        {% elif 'deepseek-r1' in model_key %}
                        Advanced reasoning & problem solving
                        {% else %}
                        High-performance AI model
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Upgrade CTA for Free Users -->
            <div class="model-group locked">
                <div class="model-group-header">
                    <span class="group-badge premium">‚≠ê Premium</span>
                    <span class="group-title">Unlock Advanced Models</span>
                </div>

                <div class="upgrade-card" onclick="location.href='/checkout'">
                    <div class="upgrade-content">
                        <div class="upgrade-icon">üîì</div>
                        <h3>Upgrade to Premium</h3>
                        <p>Get unlimited access to GPT-4, Claude 3.5, Gemini Pro & more</p>
                        <ul class="upgrade-features">
                            <li>‚úì GPT-4o & GPT-4o Mini</li>
                            <li>‚úì Claude 3.5 Sonnet (Best for coding)</li>
                            <li>‚úì Unlimited messages</li>
                            <li>‚úì Priority support</li>
                        </ul>
                        <button class="upgrade-button">Upgrade Now - $19.99/mo</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- User Menu Dropdown -->
    <div id="user-menu" class="dropdown-menu" style="display: none;">
        <div class="menu-header">
            <div class="user-avatar-large">{{ user.name[0].upper() }}</div>
            <div class="user-info">
                <div class="user-name">{{ user.name }}</div>
                <div class="user-email">{{ user.email }}</div>
                {% if user.is_premium %}
                <div class="premium-badge-small">‚≠ê Premium Member</div>
                {% else %}
                <div class="free-badge-small">Free Account</div>
                {% endif %}
            </div>
        </div>
        <div class="menu-divider"></div>
        {% if not user.is_premium %}
        <a href="/checkout" class="menu-item">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M12 2L2 12h3v8h14v-8h3L12 2zm0 2.84L18 10v8h-3v-6H9v6H6v-8l6-5.16z" />
            </svg>
            Upgrade to Premium
        </a>
        <div class="menu-divider"></div>
        {% endif %}
        <a href="/logout" class="menu-item">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
            </svg>
            Log out
        </a>
    </div>

    <!-- Sidebar with Chat History -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="section-title">Chat History</div>
                <div class="chat-history">
                    {% if chats %}
                    {% for chat in chats %}
                    <div class="chat-item" data-chat-id="{{ chat.id }}">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                        </svg>
                        <span class="chat-title">{{ chat.title }}</span>
                        <div class="chat-actions">
                            <button class="icon-btn rename-chat-btn" data-chat-id="{{ chat.id }}" title="Rename">‚úèÔ∏è</button>
                            <button class="icon-btn delete-chat-btn" data-chat-id="{{ chat.id }}" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">No chats yet. Start a new conversation!</div>
                    {% endif %}
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="usage-info">
                    {% if not user.is_premium %}
                    <div class="usage-item">
                        <span class="usage-label">DeepSeek Today:</span>
                        <span class="usage-value">{{ user.deepseek_count }}/50</span>
                    </div>
                    <div class="upgrade-cta-small">
                        <a href="/checkout">Upgrade for unlimited access ‚Üí</a>
                    </div>
                    {% else %}
                    <div class="premium-info">
                        ‚ú® You have unlimited access to all models
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-container with-sidebar" id="main-content">
        <div class="center-content">
            <!-- Welcome Section -->
            <div class="welcome-section" id="welcome-section">
                <h1 class="main-heading">What can I help with?</h1>
                <div class="suggestion-cards">
                    <div class="suggestion-card" data-suggestion="Create a weekly schedule for studying programming">
                        <div class="suggestion-icon">üìÖ</div>
                        <div class="suggestion-text">Create a schedule</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Write Python code to sort a list">
                        <div class="suggestion-icon">üíª</div>
                        <div class="suggestion-text">Write code</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Explain machine learning concepts">
                        <div class="suggestion-icon">üß†</div>
                        <div class="suggestion-text">Learn AI concepts</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Help me write a creative story">
                        <div class="suggestion-icon">‚úçÔ∏è</div>
                        <div class="suggestion-text">Write a story</div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Container -->
            <div id="messages-container"></div>
        </div>

        <!-- Input Area (Fixed at Bottom) -->
        <div class="input-wrapper">
            <div class="input-box">
                <div class="input-inner">
                    <textarea id="chat-input" placeholder="Ask anything..." rows="1"></textarea>
                    <button class="send-button" id="send-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                        </svg>
                    </button>
                </div>
                <div class="input-footer">
                    <span class="footer-text">
                        <span id="model-info">GPT-3.5 Turbo</span> ¬∑
                        NexaAI can make mistakes. Check important info.
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>

    <!-- Main JavaScript -->
    <script>
// ============ GLOBAL VARIABLES ============
let currentModel = 'gpt-3.5-turbo';
let currentChatId = null;
let isLoading = false;

// ============ UTILITY FUNCTIONS ============
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============ UI TOGGLE FUNCTIONS ============
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    if (window.innerWidth <= 1024) {
        sidebar.classList.toggle('show');
    } else {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
    }
}

function toggleUserMenu() {
    const menu = document.getElementById('user-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function toggleModelSelector() {
    const selector = document.getElementById('model-selector');
    selector.style.display = selector.style.display === 'block' ? 'none' : 'block';
}

function selectModel(modelKey, modelName) {
    currentModel = modelKey;
    document.getElementById('selected-model-name').textContent = modelName;
    document.getElementById('model-info').textContent = modelName;
    
    document.querySelectorAll('.model-card').forEach(card => card.classList.remove('active'));
    document.querySelector(`[data-model="${modelKey}"]`)?.classList.add('active');
    
    toggleModelSelector();
    console.log('‚úÖ Selected model:', modelKey);
}

// ============ CHAT MANAGEMENT ============
async function newChat() {
    try {
        const response = await fetch('/chat/new', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.success) {
            currentChatId = data.chat_id;
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('welcome-section').style.display = 'block';
            document.getElementById('chat-input').value = '';
            addChatToSidebar(data.chat_id, data.title, true);
            console.log('‚úÖ New chat created:', data.chat_id);
        }
    } catch (error) {
        console.error('‚ùå Error creating chat:', error);
        alert('Failed to create new chat');
    }
}

async function loadChat(chatId) {
    if (isLoading) return;
    isLoading = true;

    try {
        const response = await fetch(`/chat/${chatId}/messages`);
        const data = await response.json();

        currentChatId = chatId;
        document.getElementById('messages-container').innerHTML = '';
        document.getElementById('welcome-section').style.display = 'none';

        data.messages.forEach(msg => addMessage(msg.content, msg.role, msg.model, false));

        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');
        
        if (window.innerWidth <= 1024) {
            document.getElementById('sidebar').classList.remove('show');
        }
        
        console.log('‚úÖ Chat loaded:', chatId);
    } catch (error) {
        console.error('‚ùå Error loading chat:', error);
        alert('Failed to load chat');
    } finally {
        isLoading = false;
    }
}

async function renameChat(chatId) {
    const newTitle = prompt('Enter new chat title:');
    if (!newTitle || !newTitle.trim()) return;

    try {
        const response = await fetch(`/chat/${chatId}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle.trim() })
        });

        const data = await response.json();
        if (data.success) {
            document.querySelector(`[data-chat-id="${chatId}"] .chat-title`).textContent = newTitle.trim();
            console.log('‚úÖ Chat renamed:', chatId);
        }
    } catch (error) {
        console.error('‚ùå Error renaming chat:', error);
        alert('Failed to rename chat');
    }
}

async function deleteChat(chatId) {
    if (!confirm('Delete this chat? This cannot be undone.')) return;

    try {
        const response = await fetch(`/chat/${chatId}/delete`, { method: 'DELETE' });
        const data = await response.json();
        
        if (data.success) {
            document.querySelector(`[data-chat-id="${chatId}"]`)?.remove();

            if (currentChatId === chatId) {
                currentChatId = null;
                document.getElementById('messages-container').innerHTML = '';
                document.getElementById('welcome-section').style.display = 'block';
            }
            
            console.log('‚úÖ Chat deleted:', chatId);
        }
    } catch (error) {
        console.error('‚ùå Error deleting chat:', error);
        alert('Failed to delete chat');
    }
}

function addChatToSidebar(chatId, title, prepend = false) {
    const chatHistory = document.querySelector('.chat-history');
    const emptyState = chatHistory.querySelector('.empty-state');
    if (emptyState) emptyState.remove();

    const chatItem = document.createElement('div');
    chatItem.className = 'chat-item active';
    chatItem.setAttribute('data-chat-id', chatId);
    chatItem.innerHTML = `
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
        <span class="chat-title">${escapeHtml(title)}</span>
        <div class="chat-actions">
            <button class="icon-btn rename-chat-btn" data-chat-id="${chatId}" title="Rename">‚úèÔ∏è</button>
            <button class="icon-btn delete-chat-btn" data-chat-id="${chatId}" title="Delete">üóëÔ∏è</button>
        </div>
    `;

    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    
    if (prepend) {
        chatHistory.insertBefore(chatItem, chatHistory.firstChild);
    } else {
        chatHistory.appendChild(chatItem);
    }
}

// ============ MESSAGE FUNCTIONS ============
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message || isLoading) return;

    isLoading = true;
    document.getElementById('welcome-section').style.display = 'none';
    addMessage(message, 'user', '', false);

    input.value = '';
    input.style.height = 'auto';
    showTypingIndicator();

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                model: currentModel,
                chat_id: currentChatId
            })
        });

        const data = await response.json();
        removeTypingIndicator();

        if (data.error) {
            addMessage(data.error, 'error', '', false);
        } else {
            addMessage(data.response, 'assistant', data.model, true);
            currentChatId = data.chat_id;

            if (data.chat_title) {
                const existingChat = document.querySelector(`[data-chat-id="${data.chat_id}"]`);
                if (existingChat) {
                    existingChat.querySelector('.chat-title').textContent = data.chat_title;
                } else {
                    addChatToSidebar(data.chat_id, data.chat_title, true);
                }
            }

            if (data.deepseek_remaining !== null) {
                const usageValue = document.querySelector('.usage-value');
                if (usageValue) {
                    usageValue.textContent = `${50 - data.deepseek_remaining}/50`;
                }
            }
            
            console.log('‚úÖ Message sent successfully');
        }
    } catch (error) {
        removeTypingIndicator();
        addMessage('Error connecting to AI. Please try again.', 'error', '', false);
        console.error('‚ùå Error sending message:', error);
    } finally {
        isLoading = false;
    }
}

// ============ MARKDOWN & FORMATTING ============
function formatMessage(text) {
    if (typeof marked === 'undefined') {
        return escapeHtml(text).replace(/\n/g, '<br>');
    }
    
    marked.setOptions({
        highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
        },
        breaks: true,
        gfm: true
    });
    return marked.parse(text);
}
        
function addCopyButtons(messageDiv) {
    messageDiv.querySelectorAll('pre code').forEach((codeBlock) => {
        const pre = codeBlock.parentElement;
        const btn = document.createElement('button');
        btn.className = 'copy-code-btn';
        btn.textContent = 'Copy';

        btn.addEventListener('click', () => {
            navigator.clipboard.writeText(codeBlock.textContent);
            btn.textContent = 'Copied!';
            setTimeout(() => (btn.textContent = 'Copy'), 1500);
        });

        pre.style.position = 'relative';
        btn.style.position = 'absolute';
        btn.style.top = '8px';
        btn.style.right = '8px';
        pre.appendChild(btn);
    });
}

function typeWriter(text, element, speed = 15) {
    // Fix: Use different quote style or escape backticks
    const isMarkdown = text.includes('```') || text.includes('#') || text.includes('**');
    
    if (isMarkdown) {
        element.innerHTML = formatMessage(text);
        element.style.opacity = '0';
        setTimeout(() => {
            element.style.transition = 'opacity 0.5s';
            element.style.opacity = '1';
        }, 50);
        setTimeout(() => addCopyButtons(element.closest('.message-row')), 100);
    } else {
        let i = 0;
        element.textContent = '';
        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                if (i % 5 === 0) window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                setTimeout(type, speed);
            } else {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }
        type();
    }
}


function addCopyButtons(messageDiv) {
    messageDiv.querySelectorAll('pre code').forEach((codeBlock) => {
        const pre = codeBlock.parentElement;
        const language = codeBlock.className.replace(/language-|hljs /g, '') || 'code';
        
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        
        const header = document.createElement('div');
        header.className = 'code-block-header';
        header.innerHTML = `
            <span class="code-language">${language}</span>
            <button class="copy-code-btn" onclick="copyCode(this)">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
                Copy
            </button>
        `;
        
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(header);
        wrapper.appendChild(pre);
    });
}

function copyCode(button) {
    const code = button.closest('.code-block-wrapper').querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const originalHTML = button.innerHTML;
        button.innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            Copied!
        `;
        button.classList.add('copied');
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
        }, 2000);
    });
}

function addMessage(text, role, model = '', useTyping = false) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-row ${role}-row`;

    if (role === 'user') {
        messageDiv.innerHTML = `
            <div class="message user-message">
                <div class="message-content">
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            </div>
        `;
    } else if (role === 'assistant') {
        messageDiv.innerHTML = `
            <div class="message assistant-message">
                <div class="avatar">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                </div>
                <div class="message-content">
                    ${model ? `<div class="model-badge">${escapeHtml(model)}</div>` : ''}
                    <div class="message-text markdown-content"></div>
                </div>
            </div>
        `;
        container.appendChild(messageDiv);
        
        const messageTextElement = messageDiv.querySelector('.message-text');
        if (useTyping) {
            typeWriter(text, messageTextElement, 15);
        } else {
            messageTextElement.innerHTML = formatMessage(text);
            setTimeout(() => addCopyButtons(messageDiv), 0);
        }
        return;
    } else if (role === 'error') {
        messageDiv.innerHTML = `
            <div class="message error-message">
                <div class="message-content">‚ö†Ô∏è ${escapeHtml(text)}</div>
            </div>
        `;
    }

    container.appendChild(messageDiv);
    setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
}

function showTypingIndicator() {
    const container = document.getElementById('messages-container');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message-row assistant-row typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message assistant-message">
            <div class="avatar">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
            </div>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    container.appendChild(typingDiv);
    setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
}

function removeTypingIndicator() {
    document.getElementById('typing-indicator')?.remove();
}

// ============ EVENT LISTENERS ============
document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);
document.getElementById('new-chat-btn')?.addEventListener('click', newChat);
document.getElementById('model-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('close-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('user-menu-btn')?.addEventListener('click', toggleUserMenu);
document.getElementById('send-btn')?.addEventListener('click', sendMessage);

document.getElementById('chat-input')?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

document.getElementById('chat-input')?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// Model cards click
document.querySelectorAll('.model-card').forEach(card => {
    card.addEventListener('click', function() {
        selectModel(this.dataset.model, this.dataset.name);
    });
});

// Suggestion cards click
document.querySelectorAll('.suggestion-card').forEach(card => {
    card.addEventListener('click', function() {
        document.getElementById('chat-input').value = this.dataset.suggestion;
        sendMessage();
    });
});

// Delegated event listeners for dynamic content
document.addEventListener('click', function(e) {
    // Chat item clicks
    if (e.target.closest('.chat-item') && !e.target.closest('.chat-actions')) {
        const chatId = e.target.closest('.chat-item').dataset.chatId;
        if (chatId) loadChat(parseInt(chatId));
    }
    
    // Rename button
    if (e.target.closest('.rename-chat-btn')) {
        e.stopPropagation();
        const chatId = e.target.closest('.rename-chat-btn').dataset.chatId;
        if (chatId) renameChat(parseInt(chatId));
    }
    
    // Delete button
    if (e.target.closest('.delete-chat-btn')) {
        e.stopPropagation();
        const chatId = e.target.closest('.delete-chat-btn').dataset.chatId;
        if (chatId) deleteChat(parseInt(chatId));
    }
    
    // Close user menu when clicking outside
    const menu = document.getElementById('user-menu');
    if (!e.target.closest('#user-menu-btn') && !menu.contains(e.target)) {
        menu.style.display = 'none';
    }
    
    // Close model selector when clicking outside
    const selector = document.getElementById('model-selector');
    if (selector.style.display === 'block' && 
        !e.target.closest('#model-selector-btn') && 
        !e.target.closest('#close-selector-btn') &&
        !selector.contains(e.target)) {
        selector.style.display = 'none';
    }
    
    // Close sidebar on mobile when clicking outside
    if (window.innerWidth <= 1024) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('show') && 
            !e.target.closest('#sidebar-toggle') && 
            !sidebar.contains(e.target)) {
            sidebar.classList.remove('show');
        }
    }
});

console.log('‚úÖ NexaAI Dashboard loaded successfully!');
console.log('üì± Responsive design active');
console.log('ü§ñ All AI models ready');
    </script>
</body>
</html>



