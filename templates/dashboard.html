<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaAI - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2319c37d' d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .image-preview-container{display:none;padding:8px 12px;background:rgba(25,195,125,0.1);border:1px solid #19c37d;border-radius:8px;margin:8px 0;align-items:center;gap:10px;}
        .image-preview-container.active{display:flex;}
        .image-preview-thumbnail{width:48px;height:48px;border-radius:6px;object-fit:cover;border:2px solid #19c37d;}
        .image-preview-info{flex:1;font-size:0.9rem;color:#19c37d;font-weight:500;}
        .image-preview-remove{background:rgba(239,68,68,0.1);border:1px solid #ef4444;color:#ef4444;cursor:pointer;padding:4px 8px;border-radius:6px;font-size:0.85rem;font-weight:500;transition:.2s;}
        .image-preview-remove:hover{background:#ef4444;color:white;}
        .attach-button{background:transparent;border:none;color:#9ca3af;cursor:pointer;padding:8px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:.2s;}
        .attach-button:hover{background:rgba(255,255,255,0.06);color:#e5e7eb;}
        .attach-button.active{color:#19c37d!important;background:rgba(25,195,125,0.1);}
        .attach-button svg{width:20px;height:20px;}
        .generated-image-container{margin:16px 0;border-radius:12px;overflow:hidden;border:1px solid #333;}
        .generated-image-container img{width:100%;max-width:512px;display:block;}
        .download-image-btn{display:inline-block;margin-top:8px;padding:8px 16px;background:#19c37d;color:#000;text-decoration:none;border-radius:6px;font-weight:500;transition:.2s;}
        .download-image-btn:hover{background:#16a869;}
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="nav-button icon-only" id="sidebar-toggle">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            <button class="nav-button" id="new-chat-btn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <span>New chat</span>
            </button>
            <div class="logo-container">
                <svg class="logo-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
                <button class="model-selector-btn" id="model-selector-btn">
                    <span id="selected-model-name">Gemini 2.5 Flash ‚ö°</span>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-button icon-only" id="user-menu-btn">
                <div class="user-avatar">{{ user.name[0].upper() }}</div>
            </button>
        </div>
    </nav>

    <!-- Model Selector -->
    <div id="model-selector" class="model-selector-dropdown" style="display:none;">
        <div class="model-selector-header">
            <h3>Select AI Model</h3>
            <button class="close-selector" id="close-selector-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <div class="model-selector-content">
            <div class="model-group">
                <div class="model-group-header">
                    <span class="group-badge free">‚ú® All Models 100% Free</span>
                    <span class="group-title">Choose Your AI</span>
                </div>
                
                <!-- Gemini 2.5 Flash -->
                <div class="model-card active" 
                     data-model="gemini-flash" 
                     data-name="Gemini 2.5 Flash ‚ö°" 
                     data-vision="true"
                     data-imagegen="true">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <span class="icon-text">‚ö°</span>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">Gemini 2.5 Flash ‚ö°</h4>
                            <div class="model-features">
                                <span class="feature-badge vision">üì∑ Vision</span>
                                <span class="feature-badge vision">üé® Images</span>
                                <span class="feature-badge free">‚úÖ 100% Free</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        Best all-in-one free model - Fast with vision & image generation
                    </div>
                </div>

                <!-- Gemini 2.5 Pro -->
                <div class="model-card" 
                     data-model="gemini-pro" 
                     data-name="Gemini 2.5 Pro üíé" 
                     data-vision="true"
                     data-imagegen="true">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <span class="icon-text">üíé</span>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">Gemini 2.5 Pro üíé</h4>
                            <div class="model-features">
                                <span class="feature-badge vision">üì∑ Vision</span>
                                <span class="feature-badge vision">üé® Images</span>
                                <span class="feature-badge free">‚úÖ 100% Free</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        Most capable free model with advanced reasoning
                    </div>
                </div>

                <!-- Claude 3.5 Haiku -->
                <div class="model-card" 
                     data-model="claude-haiku" 
                     data-name="Claude 3.5 Haiku üé≠" 
                     data-vision="false"
                     data-imagegen="false">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <span class="icon-text">üé≠</span>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">Claude 3.5 Haiku üé≠</h4>
                            <div class="model-features">
                                <span class="feature-badge speed">‚ö° Fast</span>
                                <span class="feature-badge free">‚úÖ 100% Free</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        Fast Claude model - Great for coding & writing
                    </div>
                </div>

                <!-- DeepSeek V3 -->
                <div class="model-card" 
                     data-model="deepseek-v3" 
                     data-name="DeepSeek V3 üîç" 
                     data-vision="false"
                     data-imagegen="false">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <span class="icon-text">üîç</span>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">DeepSeek V3 üîç</h4>
                            <div class="model-features">
                                <span class="feature-badge speed">‚ö° Fast</span>
                                <span class="feature-badge free">‚úÖ 100% Free</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        Advanced reasoning & problem solving - Free forever
                    </div>
                </div>

                <!-- Mistral 7B -->
                <div class="model-card" 
                     data-model="mistral-7b" 
                     data-name="Mistral 7B ‚ö°" 
                     data-vision="false"
                     data-imagegen="false">
                    <div class="model-card-header">
                        <div class="model-icon">
                            <span class="icon-text">‚ö°</span>
                        </div>
                        <div class="model-info">
                            <h4 class="model-name">Mistral 7B ‚ö°</h4>
                            <div class="model-features">
                                <span class="feature-badge speed">‚ö° Instant</span>
                                <span class="feature-badge free">‚úÖ 100% Free</span>
                            </div>
                        </div>
                    </div>
                    <div class="model-description">
                        Lightning fast responses - Perfect for quick tasks
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Menu -->
    <div id="user-menu" class="dropdown-menu" style="display:none;">
        <div class="menu-header">
            <div class="user-avatar-large">{{ user.name[0].upper() }}</div>
            <div class="user-info">
                <div class="user-name">{{ user.name }}</div>
                <div class="user-email">{{ user.email }}</div>
                <div class="free-badge-small">‚ú® All Models Free Forever</div>
            </div>
        </div>
        <div class="menu-divider"></div>
        <a href="/logout" class="menu-item">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
            </svg>
            Log out
        </a>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="section-title">Chat History</div>
                <div class="chat-history">
                    {% if chats %}
                    {% for chat in chats %}
                    <div class="chat-item" data-chat-id="{{ chat.id }}">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                        </svg>
                        <span class="chat-title">{{ chat.title }}</span>
                        <div class="chat-actions">
                            <button class="icon-btn rename-chat-btn" data-chat-id="{{ chat.id }}">‚úèÔ∏è</button>
                            <button class="icon-btn delete-chat-btn" data-chat-id="{{ chat.id }}">üóëÔ∏è</button>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">No chats yet. Start a conversation!</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Chat -->
    <div class="main-container with-sidebar" id="main-content">
        <div class="center-content">
            <div class="welcome-section" id="welcome-section">
                <h1 class="main-heading">What can I help with?</h1>
                <div class="suggestion-cards">
                    <div class="suggestion-card" data-suggestion="Generate an image of a cyberpunk city at night">
                        <div class="suggestion-icon">üé®</div>
                        <div class="suggestion-text">Generate image</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Write Python code to analyze CSV data with pandas">
                        <div class="suggestion-icon">üíª</div>
                        <div class="suggestion-text">Write code</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Explain machine learning in simple terms">
                        <div class="suggestion-icon">üß†</div>
                        <div class="suggestion-text">Learn AI</div>
                    </div>
                    <div class="suggestion-card" data-suggestion="Help me plan a 7-day trip to Japan">
                        <div class="suggestion-icon">‚úàÔ∏è</div>
                        <div class="suggestion-text">Plan trip</div>
                    </div>
                </div>
            </div>
            <div id="messages-container"></div>
        </div>

        <!-- Input Area -->
        <div class="input-wrapper">
            <div class="input-box">
                <div class="image-preview-container" id="image-preview">
                    <img src="" alt="Preview" class="image-preview-thumbnail" id="preview-thumb">
                    <span class="image-preview-info" id="preview-name">Image attached</span>
                    <button class="image-preview-remove" onclick="removeUploadedImage()">Remove</button>
                </div>
                <div class="input-inner">
                    <input type="file" id="file-input" accept="image/*" style="display:none;">
                    <button class="attach-button" id="attach-btn" title="Attach image (Gemini only)">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                        </svg>
                    </button>
                    <textarea id="chat-input" placeholder="Ask anything..." rows="1"></textarea>
                    <button class="send-button" id="send-btn">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="input-footer">
                    <span class="footer-text"><span id="model-info">Gemini 2.5 Flash ‚ö°</span> ¬∑ All 5 models are 100% free forever</span>
                </div>
            </div>
        </div>
    </div>

    <script>
let currentModel='gemini-flash';
let currentModelSupportsVision=true;
let currentModelSupportsImageGen=true;
let currentChatId=null;
let isLoading=false;
let currentUploadedFile=null;

function escapeHtml(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML;}
function formatMessage(text){
    if(typeof marked==='undefined')return escapeHtml(text).replace(/\n/g,'<br>');
    marked.setOptions({gfm:true,breaks:true,highlight:function(code,lang){
        if(typeof hljs!=='undefined'&&lang&&hljs.getLanguage(lang))return hljs.highlight(code,{language:lang}).value;
        return typeof hljs!=='undefined'?hljs.highlightAuto(code).value:code;
    }});
    return marked.parse(text);
}
function addCopyButtons(container){
    container.querySelectorAll('pre code').forEach((codeBlock)=>{
        const pre=codeBlock.parentElement;
        const btn=document.createElement('button');
        btn.className='copy-code-btn';btn.textContent='Copy';
        btn.addEventListener('click',()=>{
            navigator.clipboard.writeText(codeBlock.textContent);
            btn.textContent='Copied!';
            setTimeout(()=>(btn.textContent='Copy'),1500);
        });
        pre.style.position='relative';btn.style.position='absolute';
        btn.style.top='8px';btn.style.right='8px';pre.appendChild(btn);
    });
}
function toggleSidebar(){const s=document.getElementById('sidebar');const m=document.getElementById('main-content');if(window.innerWidth<=1024){s.classList.toggle('show');}else{s.classList.toggle('collapsed');m.classList.toggle('sidebar-collapsed');}}
function toggleUserMenu(){const m=document.getElementById('user-menu');m.style.display=m.style.display==='block'?'none':'block';}
function toggleModelSelector(){const s=document.getElementById('model-selector');s.style.display=s.style.display==='block'?'none':'block';}
function selectModel(key,name,vision,imagegen){
    currentModel=key;currentModelSupportsVision=(vision==='true');currentModelSupportsImageGen=(imagegen==='true');
    document.getElementById('selected-model-name').textContent=name;
    document.getElementById('model-info').textContent=name;
    document.querySelectorAll('.model-card').forEach(c=>c.classList.remove('active'));
    document.querySelector(`[data-model="${key}"]`)?.classList.add('active');
    toggleModelSelector();
    if(!currentModelSupportsVision&&currentUploadedFile)removeUploadedImage();
}

async function newChat(){
    try{const res=await fetch('/chat/new',{method:'POST',headers:{'Content-Type':'application/json'}});
    const d=await res.json();if(d.success){
        currentChatId=d.chat_id;document.getElementById('messages-container').innerHTML='';
        document.getElementById('welcome-section').style.display='block';
        document.getElementById('chat-input').value='';addChatToSidebar(d.chat_id,d.title,true);
    }}catch{alert('Failed to create new chat');}
}

async function loadChat(id){
    if(isLoading)return;isLoading=true;
    try{const res=await fetch(`/chat/${id}/messages`);const d=await res.json();
        currentChatId=id;document.getElementById('messages-container').innerHTML='';
        document.getElementById('welcome-section').style.display='none';
        d.messages.forEach(m=>addMessage(m.content,m.role,m.model,false,m.has_image?m.image_path:null));
        document.querySelectorAll('.chat-item').forEach(el=>el.classList.remove('active'));
        document.querySelector(`[data-chat-id="${id}"]`)?.classList.add('active');
        if(window.innerWidth<=1024)document.getElementById('sidebar').classList.remove('show');
    }catch{alert('Failed to load chat');}finally{isLoading=false;}
}

async function renameChat(id){
    const title=prompt('Enter new chat title:');
    if(!title||!title.trim())return;
    try{const res=await fetch(`/chat/${id}/rename`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:title.trim()})});
        const d=await res.json();if(d.success)document.querySelector(`[data-chat-id="${id}"] .chat-title`).textContent=title.trim();
    }catch{alert('Failed to rename chat');}
}

async function deleteChat(id){
    if(!confirm('Delete this chat?'))return;
    try{const res=await fetch(`/chat/${id}/delete`,{method:'DELETE'});
        const d=await res.json();if(d.success){
            document.querySelector(`[data-chat-id="${id}"]`)?.remove();
            if(currentChatId===id){currentChatId=null;document.getElementById('messages-container').innerHTML='';document.getElementById('welcome-section').style.display='block';}
        }
    }catch{alert('Failed to delete chat');}
}

function addChatToSidebar(id,title,prepend=false){
    const h=document.querySelector('.chat-history');const e=h.querySelector('.empty-state');
    if(e)e.remove();const item=document.createElement('div');
    item.className='chat-item active';item.dataset.chatId=id;
    item.innerHTML=`<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg><span class="chat-title">${escapeHtml(title)}</span><div class="chat-actions"><button class="icon-btn rename-chat-btn" data-chat-id="${id}">‚úèÔ∏è</button><button class="icon-btn delete-chat-btn" data-chat-id="${id}">üóëÔ∏è</button></div>`;
    item.onclick=()=>loadChat(id);
    document.querySelectorAll('.chat-item').forEach(el=>el.classList.remove('active'));
    if(prepend)h.insertBefore(item,h.firstChild);else h.appendChild(item);
}

function handleKeyDown(event){if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}}

async function uploadImage(file){
    const fd=new FormData();fd.append('file',file);
    try{const res=await fetch('/upload',{method:'POST',body:fd});
        const d=await res.json();if(d.success)return d.filename;
        throw new Error(d.error||'Upload failed');
    }catch(e){throw e;}
}

function removeUploadedImage(){
    currentUploadedFile=null;
    document.getElementById('file-input').value='';
    document.getElementById('image-preview').classList.remove('active');
    document.getElementById('attach-btn').classList.remove('active');
}

async function sendMessage(){
    const input=document.getElementById('chat-input');
    let message=input.value.trim();
    if(!message||isLoading)return;
    
    const isImageGenRequest=message.toLowerCase().match(/^(generate|create|make|draw).*(image|picture|photo|art)/);
    
    if(isImageGenRequest&&!currentModelSupportsImageGen){
        alert('Switch to Gemini models to generate images!');return;
    }
    
    isLoading=true;document.getElementById('welcome-section').style.display='none';
    
    let uploadedFilename=null;
    if(currentUploadedFile&&!isImageGenRequest){
        try{uploadedFilename=await uploadImage(currentUploadedFile);
        }catch(e){alert('Failed to upload image: '+e.message);isLoading=false;return;}
    }
    
    addMessage(message,'user','',false,uploadedFilename);
    input.value='';input.style.height='auto';removeUploadedImage();
    showTypingIndicator();
    
    try{
        if(isImageGenRequest&&currentModelSupportsImageGen){
            const res=await fetch('/generate-image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:message,model:currentModel})});
            const d=await res.json();removeTypingIndicator();
            if(d.error){addMessage(d.error,'error','',false);}
            else{const imgHtml=`<div class="generated-image-container"><img src="${d.url}" alt="${escapeHtml(d.prompt)}"/><br><a href="${d.url}" download="nexaai_${d.filename}" class="download-image-btn">üì• Download Image</a></div><p>‚ú® Generated: <strong>${escapeHtml(d.prompt)}</strong> using ${escapeHtml(d.generator)}</p>`;
                addMessage(imgHtml,'assistant','Image Generator',false);}
        }else{
            const res=await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message,model:currentModel,chat_id:currentChatId,uploaded_file:uploadedFilename})});
            const d=await res.json();removeTypingIndicator();
            if(d.error){addMessage(d.error,'error','',false);}
            else{addMessage(d.response,'assistant',d.model,true);currentChatId=d.chat_id;
                if(d.chat_title){const ex=document.querySelector(`[data-chat-id="${d.chat_id}"]`);
                    if(ex)ex.querySelector('.chat-title').textContent=d.chat_title;
                    else addChatToSidebar(d.chat_id,d.chat_title,true);
                }
            }
        }
    }catch{removeTypingIndicator();addMessage('Error connecting to AI. Please try again.','error','',false);}
    finally{isLoading=false;}
}

function useSuggestion(text){document.getElementById('chat-input').value=text;sendMessage();}

function addMessage(text,role,model='',useTyping=false,imagePath=null){
    const c=document.getElementById('messages-container');
    const row=document.createElement('div');
    row.className=`message-row ${role}-row`;
    
    if(role==='user'){
        let content=`<div class="message-text">${escapeHtml(text)}</div>`;
        if(imagePath){content+=`<br><img src="/uploads/${imagePath}" style="max-width:300px;border-radius:8px;margin-top:8px;"/>`;}
        row.innerHTML=`<div class="message user-message"><div class="message-content">${content}</div></div>`;
        c.appendChild(row);c.scrollTop=c.scrollHeight;return;
    }
    
    if(role==='assistant'){
        row.innerHTML=`<div class="message assistant-message"><div class="avatar"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg></div><div class="message-content">${model?`<div class="model-badge">${escapeHtml(model)}</div>`:''}<div class="message-text markdown-content"></div></div></div>`;
        c.appendChild(row);
        const el=row.querySelector('.message-text');
        el.innerHTML=formatMessage(text);
        el.querySelectorAll('pre code').forEach(block=>hljs.highlightElement(block));
        addCopyButtons(el);c.scrollTop=c.scrollHeight;return;
    }
    
    row.innerHTML=`<div class="message error-message"><div class="message-content">${escapeHtml(text)}</div></div>`;
    c.appendChild(row);c.scrollTop=c.scrollHeight;
}

function showTypingIndicator(){
    const c=document.getElementById('messages-container');const d=document.createElement('div');
    d.className='message-row assistant-row typing-indicator';d.id='typing-indicator';
    d.innerHTML='<div class="message assistant-message"><div class="avatar"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg></div><div class="typing-dots"><span></span><span></span><span></span></div></div>';
    c.appendChild(d);c.scrollTop=c.scrollHeight;
}

function removeTypingIndicator(){document.getElementById('typing-indicator')?.remove();}

document.getElementById('sidebar-toggle')?.addEventListener('click',toggleSidebar);
document.getElementById('new-chat-btn')?.addEventListener('click',newChat);
document.getElementById('model-selector-btn')?.addEventListener('click',toggleModelSelector);
document.getElementById('close-selector-btn')?.addEventListener('click',toggleModelSelector);
document.getElementById('user-menu-btn')?.addEventListener('click',toggleUserMenu);
document.getElementById('send-btn')?.addEventListener('click',sendMessage);
document.getElementById('chat-input')?.addEventListener('keydown',handleKeyDown);

document.getElementById('attach-btn')?.addEventListener('click',()=>{
    if(!currentModelSupportsVision){alert('Switch to Gemini models to use vision!');return;}
    document.getElementById('file-input').click();
});

document.getElementById('file-input')?.addEventListener('change',function(){
    const file=this.files[0];
    if(!file)return;
    if(!file.type.startsWith('image/')){alert('Please select an image file');return;}
    currentUploadedFile=file;
    const reader=new FileReader();
    reader.onload=function(e){
        document.getElementById('preview-thumb').src=e.target.result;
        document.getElementById('preview-name').textContent=file.name;
        document.getElementById('image-preview').classList.add('active');
        document.getElementById('attach-btn').classList.add('active');
    };
    reader.readAsDataURL(file);
});

document.getElementById('chat-input').addEventListener('input',function(){
    this.style.height='auto';this.style.height=Math.min(this.scrollHeight,200)+'px';
});

document.addEventListener('click',(e)=>{
    const menu=document.getElementById('user-menu');
    const btn=e.target.closest('#user-menu-btn');
    if(!btn&&!menu.contains(e.target))menu.style.display='none';
    
    const selector=document.getElementById('model-selector');
    const selectorBtn=e.target.closest('#model-selector-btn');
    if(!selectorBtn&&!selector.contains(e.target))selector.style.display='none';
});

document.addEventListener('click',function(e){
    if(e.target.classList.contains('rename-chat-btn')){
        e.stopPropagation();renameChat(parseInt(e.target.dataset.chatId));
    }
    if(e.target.classList.contains('delete-chat-btn')){
        e.stopPropagation();deleteChat(parseInt(e.target.dataset.chatId));
    }
    if(e.target.closest('.chat-item')){
        const chatId=parseInt(e.target.closest('.chat-item').dataset.chatId);
        if(!e.target.closest('.chat-actions'))loadChat(chatId);
    }
    if(e.target.closest('.suggestion-card')){
        const suggestion=e.target.closest('.suggestion-card').dataset.suggestion;
        useSuggestion(suggestion);
    }
    if(e.target.closest('.model-card')){
        const card=e.target.closest('.model-card');
        selectModel(card.dataset.model,card.dataset.name,card.dataset.vision,card.dataset.imagegen);
    }
});
    </script>
</body>
</html>

