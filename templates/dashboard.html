{# templates/dashboard.html - SPA master shell (Option B) #}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NexaAI — Dashboard</title>

  <!-- MUST be static/css/style.css (case-sensitive) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">

  <!-- Markdown + highlight -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <meta name="robots" content="noindex">
</head>

<body>
  <!-- Top Navigation -->
  <nav class="top-nav" role="navigation" aria-label="Top Navigation">
    <div class="nav-left">
      <div class="logo-container" style="cursor:pointer" onclick="Router.load('chat')">
        <div class="logo-icon" aria-hidden="true">N</div>
        <div class="logo-text">NexaAI</div>
      </div>

      <button class="nav-button icon-only" onclick="UI.toggleSidebar()" title="Toggle sidebar" aria-label="Toggle sidebar">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
          <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
      </button>

      <button class="nav-button" onclick="Chat.newChatAndOpen()" title="New chat">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        <span>New chat</span>
      </button>

      <button id="model-selector-btn" class="model-selector-btn" onclick="Models.toggleSelector()"
              aria-haspopup="true" aria-expanded="false">
        <span id="selected-model-name">
          {{ models.get(session.get('selected_model','gemini-flash'), models.get('gemini-flash'))['name'] }}
        </span>
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
          <path d="M7 10l5 5 5-5z"/>
        </svg>
      </button>
    </div>

    <div class="nav-right">
      {% if not user.is_premium %}
        <button class="nav-button upgrade-btn" onclick="location.href='/checkout'">
          <span>⭐ Upgrade</span>
        </button>
      {% else %}
        <div class="premium-badge-nav">⭐ Premium</div>
      {% endif %}

      <button class="nav-button icon-only" onclick="UI.toggleUserMenu()" aria-haspopup="true" aria-expanded="false" title="Account menu">
        <div class="user-avatar" aria-hidden="true">{{ user.name[0].upper() }}</div>
      </button>
    </div>
  </nav>

  <!-- Model Selector -->
  <div id="model-selector-dropdown" class="model-selector-dropdown" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="model-selector-header">
      <h3>Select AI Model</h3>
      <button class="close-selector" onclick="Models.toggleSelector(false)" aria-label="Close model selector">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="model-selector-content">
      <div class="model-group">
        <div class="model-group-header">
          <span class="group-badge free">Free</span>
          <span class="group-title">Available for Everyone</span>
        </div>
        <div id="models-free-list"></div>
      </div>

      <div class="model-group" id="models-premium-group" style="display:none;">
        <div class="model-group-header">
          <span class="group-badge premium">⭐ Premium</span>
          <span class="group-title">Premium Models</span>
        </div>
        <div id="models-premium-list"></div>
      </div>

      <div id="model-upgrade-cta" style="margin-top:1rem;"></div>
    </div>
  </div>

  <!-- User Menu -->
  <div id="user-menu" class="dropdown-menu" role="menu" aria-hidden="true" style="display:none;">
    <div class="menu-header">
      <div class="user-avatar-large">{{ user.name[0].upper() }}</div>
      <div class="user-info">
        <div class="user-name">{{ user.name }}</div>
        <div class="user-email">{{ user.email }}</div>
        {% if user.is_premium %}
          <div class="premium-badge-small">⭐ Premium Member</div>
        {% else %}
          <div class="free-badge-small">Free Account</div>
        {% endif %}
      </div>
    </div>
    <div class="menu-divider"></div>

    {% if not user.is_premium %}
      <a href="/checkout" class="menu-item">Upgrade to Premium</a>
    {% endif %}

    <a href="/logout" class="menu-item">Log out</a>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-label="Sidebar">
    <div class="sidebar-content">
      <div class="sidebar-section">
        <div class="section-title">Recent Chats</div>
        <div id="chat-history" class="chat-history" role="list">
          <div class="empty-state">Loading chats…</div>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="usage-info">
        <div class="usage-item">
          <span class="usage-label">DeepSeek Today</span>
          <span class="usage-value">{{ user.deepseek_count or 0 }}/50</span>
        </div>

        {% if not user.is_premium %}
          <div class="upgrade-cta-small">
            <a href="/checkout">Upgrade for unlimited access →</a>
          </div>
        {% else %}
          <div class="premium-info">✨ Unlimited Messages</div>
        {% endif %}
      </div>
    </div>
  </aside>

  <!-- Main -->
  <div id="main-container" class="main-container with-sidebar">
    <div id="view-container" class="center-content" role="main" tabindex="-1">
      <div class="loading">Loading interface…</div>
    </div>
  </div>

  <!-- Expose server-side -->
  <script>
    window.NEXA = {
      currentUser: {{ {'id': user.id, 'name': user.name, 'is_premium': user.is_premium} | tojson }},
      models: {{ models | tojson }},
      selectedModel: "{{ session.get('selected_model','gemini-flash') }}"
    };
  </script>

  <!-- Core JS (defer keeps order but waits for HTML parse) -->
  <script defer src="{{ url_for('static', filename='js/router.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/ui.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/model-selector.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/chat.js') }}"></script>

  <script defer>
    document.addEventListener('DOMContentLoaded', async () => {
      UI.init();
      Models.init(window.NEXA.models, window.NEXA.selectedModel, window.NEXA.currentUser);
      Chat.init();
      await Router.load('chat');
      await Chat.refreshSidebar();
    });

    document.addEventListener('click', (ev) => {
      UI.handleGlobalOutsideClick(ev);
    });
  </script>
</body>
</html>

