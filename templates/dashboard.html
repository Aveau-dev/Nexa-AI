<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaAI - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2319c37d' d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>">
    <!-- IMPORTANT: folder name matches your project: static/Css/style.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexaAI - Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2319c37d' d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/></svg>">
    <!-- IMPORTANT: folder name matches your project: static/Css/style.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- TOP NAV, MODEL SELECTOR, USER MENU, SIDEBAR, MAIN AREA: your HTML stays the same -->
    <!-- ========= COPY EVERYTHING FROM YOUR LAST WORKING VERSION UP TO JUST BEFORE <script> ========= -->
    <!-- (To save space here, only the <script> block is rewritten.) -->

    <!-- ‚Ä¶ your existing HTML above ‚Ä¶ -->

    <script>
/* ============ GLOBAL ============ */
let currentModel = 'gpt-3.5-turbo';
let currentChatId = null;
let isLoading = false;

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

/* ============ MARKDOWN + HIGHLIGHT + COPY (SAME AS INDEX) ============ */
function formatMessage(text) {
    if (typeof marked === 'undefined') {
        return escapeHtml(text).replace(/\n/g, '<br>');
    }
    marked.setOptions({
        gfm: true,
        breaks: true,
        highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return typeof hljs !== 'undefined'
                ? hljs.highlightAuto(code).value
                : code;
        }
    });
    return marked.parse(text);
}

function addCopyButtons(container) {
    container.querySelectorAll('pre code').forEach((codeBlock) => {
        const pre = codeBlock.parentElement;
        const btn = document.createElement('button');
        btn.className = 'copy-code-btn';
        btn.textContent = 'Copy';

        btn.addEventListener('click', () => {
            navigator.clipboard.writeText(codeBlock.textContent);
            btn.textContent = 'Copied!';
            setTimeout(() => (btn.textContent = 'Copy'), 1500);
        });

        pre.style.position = 'relative';
        btn.style.position = 'absolute';
        btn.style.top = '8px';
        btn.style.right = '8px';
        pre.appendChild(btn);
    });
}

/* ============ SIDEBAR / MENUS ============ */
function toggleSidebar() {
    const s = document.getElementById('sidebar');
    const m = document.getElementById('main-content');
    if (window.innerWidth <= 1024) {
        s.classList.toggle('show');
    } else {
        s.classList.toggle('collapsed');
        m.classList.toggle('sidebar-collapsed');
    }
}

function toggleUserMenu() {
    const m = document.getElementById('user-menu');
    m.style.display = m.style.display === 'block' ? 'none' : 'block';
}

function toggleModelSelector() {
    const s = document.getElementById('model-selector');
    s.style.display = s.style.display === 'block' ? 'none' : 'block';
}

function selectModel(key, name) {
    currentModel = key;
    document.getElementById('selected-model-name').textContent = name;
    document.getElementById('model-info').textContent = name;
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-model="${key}"]`)?.classList.add('active');
    toggleModelSelector();
}

/* ============ CHAT MANAGEMENT ============ */
async function newChat() {
    try {
        const res = await fetch('/chat/new', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const d = await res.json();
        if (d.success) {
            currentChatId = d.chat_id;
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('welcome-section').style.display = 'block';
            document.getElementById('chat-input').value = '';
            addChatToSidebar(d.chat_id, d.title, true);
        }
    } catch {
        alert('Failed to create new chat');
    }
}

async function loadChat(id) {
    if (isLoading) return;
    isLoading = true;
    try {
        const res = await fetch(`/chat/${id}/messages`);
        const d = await res.json();
        currentChatId = id;
        const mc = document.getElementById('messages-container');
        mc.innerHTML = '';
        document.getElementById('welcome-section').style.display = 'none';
        d.messages.forEach(m => addMessage(m.content, m.role, m.model, false));
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-chat-id="${id}"]`)?.classList.add('active');
        if (window.innerWidth <= 1024) document.getElementById('sidebar').classList.remove('show');
    } catch {
        alert('Failed to load chat');
    } finally {
        isLoading = false;
    }
}

async function renameChat(id) {
    const title = prompt('Enter new chat title:');
    if (!title || !title.trim()) return;
    try {
        const res = await fetch(`/chat/${id}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title.trim() })
        });
        const d = await res.json();
        if (d.success) {
            document.querySelector(`[data-chat-id="${id}"] .chat-title`).textContent = title.trim();
        }
    } catch {
        alert('Failed to rename chat');
    }
}

async function deleteChat(id) {
    if (!confirm('Delete this chat?')) return;
    try {
        const res = await fetch(`/chat/${id}/delete`, { method: 'DELETE' });
        const d = await res.json();
        if (d.success) {
            document.querySelector(`[data-chat-id="${id}"]`)?.remove();
            if (currentChatId === id) {
                currentChatId = null;
                document.getElementById('messages-container').innerHTML = '';
                document.getElementById('welcome-section').style.display = 'block';
            }
        }
    } catch {
        alert('Failed to delete chat');
    }
}

function addChatToSidebar(id, title, prepend = false) {
    const h = document.querySelector('.chat-history');
    const e = h.querySelector('.empty-state'); if (e) e.remove();
    const item = document.createElement('div');
    item.className = 'chat-item active';
    item.dataset.chatId = id;
    item.innerHTML = `
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
        <span class="chat-title">${escapeHtml(title)}</span>
        <div class="chat-actions">
            <button class="icon-btn rename-chat-btn" data-chat-id="${id}">‚úèÔ∏è</button>
            <button class="icon-btn delete-chat-btn" data-chat-id="${id}">üóëÔ∏è</button>
        </div>`;
    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    if (prepend) h.insertBefore(item, h.firstChild); else h.appendChild(item);
}

/* ============ SENDING & RENDERING MESSAGES ============ */
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message || isLoading) return;

    isLoading = true;
    document.getElementById('welcome-section').style.display = 'none';
    addMessage(message, 'user', '', false);
    input.value = '';
    input.style.height = 'auto';
    showTypingIndicator();

    try {
        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, model: currentModel, chat_id: currentChatId })
        });
        const d = await res.json();
        removeTypingIndicator();
        if (d.error) {
            addMessage(d.error, 'error', '', false);
        } else {
            addMessage(d.response, 'assistant', d.model, true);
            currentChatId = d.chat_id;
            if (d.chat_title) {
                const ex = document.querySelector(`[data-chat-id="${d.chat_id}"]`);
                if (ex) ex.querySelector('.chat-title').textContent = d.chat_title;
                else addChatToSidebar(d.chat_id, d.chat_title, true);
            }
        }
    } catch {
        removeTypingIndicator();
        addMessage('Error connecting to AI. Please try again.', 'error', '', false);
    } finally {
        isLoading = false;
    }
}

function addMessage(text, role, model = '', useTyping = false) {
    const c = document.getElementById('messages-container');
    const row = document.createElement('div');
    row.className = `message-row ${role}-row`;

    if (role === 'user') {
        row.innerHTML = `
            <div class="message user-message">
                <div class="message-content"><div class="message-text">${escapeHtml(text)}</div></div>
            </div>`;
        c.appendChild(row);
        c.scrollTop = c.scrollHeight;
        return;
    }

    if (role === 'assistant') {
        row.innerHTML = `
            <div class="message assistant-message">
                <div class="avatar">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                </div>
                <div class="message-content">
                    ${model ? `<div class="model-badge">${escapeHtml(model)}</div>` : ''}
                    <div class="message-text markdown-content"></div>
                </div>
            </div>`;
        c.appendChild(row);
        const el = row.querySelector('.message-text');
        el.innerHTML = formatMessage(text);
        el.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        addCopyButtons(el);
        c.scrollTop = c.scrollHeight;
        return;
    }

    // error
    row.innerHTML = `
        <div class="message error-message">
            <div class="message-content">‚ö†Ô∏è ${escapeHtml(text)}</div>
        </div>`;
    c.appendChild(row);
    c.scrollTop = c.scrollHeight;
}

/* ============ TYPING INDICATOR ============ */
function showTypingIndicator() {
    const c = document.getElementById('messages-container');
    const d = document.createElement('div');
    d.className = 'message-row assistant-row typing-indicator';
    d.id = 'typing-indicator';
    d.innerHTML = `
        <div class="message assistant-message">
            <div class="avatar">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
            </div>
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>`;
    c.appendChild(d);
    c.scrollTop = c.scrollHeight;
}

function removeTypingIndicator() {
    document.getElementById('typing-indicator')?.remove();
}

/* ============ EVENT LISTENERS ============ */
document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);
document.getElementById('new-chat-btn')?.addEventListener('click', newChat);
document.getElementById('model-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('close-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('user-menu-btn')?.addEventListener('click', toggleUserMenu);
document.getElementById('send-btn')?.addEventListener('click', sendMessage);

document.getElementById('chat-input')?.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
document.getElementById('chat-input')?.addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

document.querySelectorAll('.model-card').forEach(card => {
    card.addEventListener('click', function () {
        selectModel(this.dataset.model, this.dataset.name);
    });
});

document.querySelectorAll('.suggestion-card').forEach(card => {
    card.addEventListener('click', function () {
        document.getElementById('chat-input').value = this.dataset.suggestion;
        sendMessage();
    });
});

document.addEventListener('click', e => {
    if (e.target.closest('.chat-item') && !e.target.closest('.chat-actions')) {
        const id = e.target.closest('.chat-item').dataset.chatId;
        if (id) loadChat(parseInt(id));
    }
    if (e.target.closest('.rename-chat-btn')) {
        e.stopPropagation();
        renameChat(parseInt(e.target.closest('.rename-chat-btn').dataset.chatId));
    }
    if (e.target.closest('.delete-chat-btn')) {
        e.stopPropagation();
        deleteChat(parseInt(e.target.closest('.delete-chat-btn').dataset.chatId));
    }
    const menu = document.getElementById('user-menu');
    if (menu && !e.target.closest('#user-menu-btn') && !menu.contains(e.target)) menu.style.display = 'none';
    const sel = document.getElementById('model-selector');
    if (sel.style.display === 'block' &&
        !e.target.closest('#model-selector-btn') &&
        !e.target.closest('#close-selector-btn') &&
        !sel.contains(e.target)) sel.style.display = 'none';
    if (window.innerWidth <= 1024) {
        const s = document.getElementById('sidebar');
        if (s.classList.contains('show') &&
            !e.target.closest('#sidebar-toggle') &&
            !s.contains(e.target)) s.classList.remove('show');
    }
});
    </script>
</body>
</html>

    <script>
/* ============ GLOBAL ============ */
let currentModel = 'gpt-3.5-turbo';
let currentChatId = null;
let isLoading = false;

function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

/* ============ MARKDOWN + HIGHLIGHT + COPY (SAME AS INDEX) ============ */
function formatMessage(text) {
    if (typeof marked === 'undefined') {
        return escapeHtml(text).replace(/\n/g, '<br>');
    }
    marked.setOptions({
        gfm: true,
        breaks: true,
        highlight: function (code, lang) {
            if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return typeof hljs !== 'undefined'
                ? hljs.highlightAuto(code).value
                : code;
        }
    });
    return marked.parse(text);
}

function addCopyButtons(container) {
    container.querySelectorAll('pre code').forEach((codeBlock) => {
        const pre = codeBlock.parentElement;
        const btn = document.createElement('button');
        btn.className = 'copy-code-btn';
        btn.textContent = 'Copy';

        btn.addEventListener('click', () => {
            navigator.clipboard.writeText(codeBlock.textContent);
            btn.textContent = 'Copied!';
            setTimeout(() => (btn.textContent = 'Copy'), 1500);
        });

        pre.style.position = 'relative';
        btn.style.position = 'absolute';
        btn.style.top = '8px';
        btn.style.right = '8px';
        pre.appendChild(btn);
    });
}

/* ============ SIDEBAR / MENUS ============ */
function toggleSidebar() {
    const s = document.getElementById('sidebar');
    const m = document.getElementById('main-content');
    if (window.innerWidth <= 1024) {
        s.classList.toggle('show');
    } else {
        s.classList.toggle('collapsed');
        m.classList.toggle('sidebar-collapsed');
    }
}

function toggleUserMenu() {
    const m = document.getElementById('user-menu');
    m.style.display = m.style.display === 'block' ? 'none' : 'block';
}

function toggleModelSelector() {
    const s = document.getElementById('model-selector');
    s.style.display = s.style.display === 'block' ? 'none' : 'block';
}

function selectModel(key, name) {
    currentModel = key;
    document.getElementById('selected-model-name').textContent = name;
    document.getElementById('model-info').textContent = name;
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-model="${key}"]`)?.classList.add('active');
    toggleModelSelector();
}

/* ============ CHAT MANAGEMENT ============ */
async function newChat() {
    try {
        const res = await fetch('/chat/new', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const d = await res.json();
        if (d.success) {
            currentChatId = d.chat_id;
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('welcome-section').style.display = 'block';
            document.getElementById('chat-input').value = '';
            addChatToSidebar(d.chat_id, d.title, true);
        }
    } catch {
        alert('Failed to create new chat');
    }
}

async function loadChat(id) {
    if (isLoading) return;
    isLoading = true;
    try {
        const res = await fetch(`/chat/${id}/messages`);
        const d = await res.json();
        currentChatId = id;
        const mc = document.getElementById('messages-container');
        mc.innerHTML = '';
        document.getElementById('welcome-section').style.display = 'none';
        d.messages.forEach(m => addMessage(m.content, m.role, m.model, false));
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-chat-id="${id}"]`)?.classList.add('active');
        if (window.innerWidth <= 1024) document.getElementById('sidebar').classList.remove('show');
    } catch {
        alert('Failed to load chat');
    } finally {
        isLoading = false;
    }
}

async function renameChat(id) {
    const title = prompt('Enter new chat title:');
    if (!title || !title.trim()) return;
    try {
        const res = await fetch(`/chat/${id}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title.trim() })
        });
        const d = await res.json();
        if (d.success) {
            document.querySelector(`[data-chat-id="${id}"] .chat-title`).textContent = title.trim();
        }
    } catch {
        alert('Failed to rename chat');
    }
}

async function deleteChat(id) {
    if (!confirm('Delete this chat?')) return;
    try {
        const res = await fetch(`/chat/${id}/delete`, { method: 'DELETE' });
        const d = await res.json();
        if (d.success) {
            document.querySelector(`[data-chat-id="${id}"]`)?.remove();
            if (currentChatId === id) {
                currentChatId = null;
                document.getElementById('messages-container').innerHTML = '';
                document.getElementById('welcome-section').style.display = 'block';
            }
        }
    } catch {
        alert('Failed to delete chat');
    }
}

function addChatToSidebar(id, title, prepend = false) {
    const h = document.querySelector('.chat-history');
    const e = h.querySelector('.empty-state'); if (e) e.remove();
    const item = document.createElement('div');
    item.className = 'chat-item active';
    item.dataset.chatId = id;
    item.innerHTML = `
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
        <span class="chat-title">${escapeHtml(title)}</span>
        <div class="chat-actions">
            <button class="icon-btn rename-chat-btn" data-chat-id="${id}">‚úèÔ∏è</button>
            <button class="icon-btn delete-chat-btn" data-chat-id="${id}">üóëÔ∏è</button>
        </div>`;
    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    if (prepend) h.insertBefore(item, h.firstChild); else h.appendChild(item);
}

/* ============ SENDING & RENDERING MESSAGES ============ */
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message || isLoading) return;

    isLoading = true;
    document.getElementById('welcome-section').style.display = 'none';
    addMessage(message, 'user', '', false);
    input.value = '';
    input.style.height = 'auto';
    showTypingIndicator();

    try {
        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, model: currentModel, chat_id: currentChatId })
        });
        const d = await res.json();
        removeTypingIndicator();
        if (d.error) {
            addMessage(d.error, 'error', '', false);
        } else {
            addMessage(d.response, 'assistant', d.model, true);
            currentChatId = d.chat_id;
            if (d.chat_title) {
                const ex = document.querySelector(`[data-chat-id="${d.chat_id}"]`);
                if (ex) ex.querySelector('.chat-title').textContent = d.chat_title;
                else addChatToSidebar(d.chat_id, d.chat_title, true);
            }
        }
    } catch {
        removeTypingIndicator();
        addMessage('Error connecting to AI. Please try again.', 'error', '', false);
    } finally {
        isLoading = false;
    }
}

function addMessage(text, role, model = '', useTyping = false) {
    const c = document.getElementById('messages-container');
    const row = document.createElement('div');
    row.className = `message-row ${role}-row`;

    if (role === 'user') {
        row.innerHTML = `
            <div class="message user-message">
                <div class="message-content"><div class="message-text">${escapeHtml(text)}</div></div>
            </div>`;
        c.appendChild(row);
        c.scrollTop = c.scrollHeight;
        return;
    }

    if (role === 'assistant') {
        row.innerHTML = `
            <div class="message assistant-message">
                <div class="avatar">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                    </svg>
                </div>
                <div class="message-content">
                    ${model ? `<div class="model-badge">${escapeHtml(model)}</div>` : ''}
                    <div class="message-text markdown-content"></div>
                </div>
            </div>`;
        c.appendChild(row);
        const el = row.querySelector('.message-text');
        el.innerHTML = formatMessage(text);
        el.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        addCopyButtons(el);
        c.scrollTop = c.scrollHeight;
        return;
    }

    // error
    row.innerHTML = `
        <div class="message error-message">
            <div class="message-content">‚ö†Ô∏è ${escapeHtml(text)}</div>
        </div>`;
    c.appendChild(row);
    c.scrollTop = c.scrollHeight;
}

/* ============ TYPING INDICATOR ============ */
function showTypingIndicator() {
    const c = document.getElementById('messages-container');
    const d = document.createElement('div');
    d.className = 'message-row assistant-row typing-indicator';
    d.id = 'typing-indicator';
    d.innerHTML = `
        <div class="message assistant-message">
            <div class="avatar">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
            </div>
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>`;
    c.appendChild(d);
    c.scrollTop = c.scrollHeight;
}

function removeTypingIndicator() {
    document.getElementById('typing-indicator')?.remove();
}

/* ============ EVENT LISTENERS ============ */
document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebar);
document.getElementById('new-chat-btn')?.addEventListener('click', newChat);
document.getElementById('model-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('close-selector-btn')?.addEventListener('click', toggleModelSelector);
document.getElementById('user-menu-btn')?.addEventListener('click', toggleUserMenu);
document.getElementById('send-btn')?.addEventListener('click', sendMessage);

document.getElementById('chat-input')?.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
document.getElementById('chat-input')?.addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

document.querySelectorAll('.model-card').forEach(card => {
    card.addEventListener('click', function () {
        selectModel(this.dataset.model, this.dataset.name);
    });
});

document.querySelectorAll('.suggestion-card').forEach(card => {
    card.addEventListener('click', function () {
        document.getElementById('chat-input').value = this.dataset.suggestion;
        sendMessage();
    });
});

document.addEventListener('click', e => {
    if (e.target.closest('.chat-item') && !e.target.closest('.chat-actions')) {
        const id = e.target.closest('.chat-item').dataset.chatId;
        if (id) loadChat(parseInt(id));
    }
    if (e.target.closest('.rename-chat-btn')) {
        e.stopPropagation();
        renameChat(parseInt(e.target.closest('.rename-chat-btn').dataset.chatId));
    }
    if (e.target.closest('.delete-chat-btn')) {
        e.stopPropagation();
        deleteChat(parseInt(e.target.closest('.delete-chat-btn').dataset.chatId));
    }
    const menu = document.getElementById('user-menu');
    if (menu && !e.target.closest('#user-menu-btn') && !menu.contains(e.target)) menu.style.display = 'none';
    const sel = document.getElementById('model-selector');
    if (sel.style.display === 'block' &&
        !e.target.closest('#model-selector-btn') &&
        !e.target.closest('#close-selector-btn') &&
        !sel.contains(e.target)) sel.style.display = 'none';
    if (window.innerWidth <= 1024) {
        const s = document.getElementById('sidebar');
        if (s.classList.contains('show') &&
            !e.target.closest('#sidebar-toggle') &&
            !s.contains(e.target)) s.classList.remove('show');
    }
});
    </script>
</body>
</html>
